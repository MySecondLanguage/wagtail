{% load wagtailadmin_tags i18n %}

{# TODO: set icon="workflow_icon_name" #}
{% include "wagtailadmin/shared/header.html" with title=workflow_state.workflow.name %}

<div class="nice-padding">
    {% if page.get_latest_revision %}
        <p>
        {% blocktrans trimmed with workflow_name=workflow_state.workflow.name started_at=workflow_state.created_at %}
            Submitted to <em>{{ workflow_name }}</em> at {{ started_at }}
        {% endblocktrans %}
        {% if workflow_state.requested_by %}
            {% blocktrans with modified_by=workflow_state.requested_by.get_full_name|default:workflow_state.requested_by.get_username %}by {{ modified_by }}{% endblocktrans %}
            <span class="avatar small"><img src="{% avatar_url page.get_latest_revision.user size=25 %}" alt="" /></span>
        {% endif %}
        </p>
    {% endif %}

    <ul class="workflow-timeline">
        <li class="approved">{% icon name="success" class_name="default" %}{% trans "Submitted" %}</li>
    {% for task in workflow_tasks %}
        <li data-wagtail-tooltip="{{ task.name }}: {{ task.status_display }}" {% if task.status %}class="{{ task.status }}"{% endif %}>
            {% if task.status == "rejected" %}
                {% icon name="warning" class_name="default" %}<strong>{{ task.name }}</strong>

                {% if current_task_state and current_task_state.task_id == task.id %}
                    {% blocktrans trimmed with requested_by=current_task_state.finished_by.get_full_name|default:current_task_state.finished_by.get_username %}
                        Changes requested by {{ requested_by }}
                    {% endblocktrans %}

                    {% if current_task_state.get_comment %}
                        {% trans "with comment:" %} <em>"{{ current_task_state.get_comment }}"</em>
                    {% endif %}
                {% endif %}
            {% else %}
                {% icon name="success" class_name="default" %}{{ task.name }}
            {% endif %}
        </li>
    {% endfor %}
        <li>{% icon name="success" class_name="default" %}{% trans "Published" %}</li>
    </ul>

    <p>
        <a href="{% url 'wagtailadmin_pages:history' page.id %}" class="button button-small">
            {% trans "See full history" %}
        </a>
        {% with page.get_latest_revision as latest_revision %}
            {% if page.live_revision %}
                <a href="{% url 'wagtailadmin_pages:revisions_compare' page.id 'live' latest_revision.id %}" class="button button-small button-secondary">
                    {% trans "Compare with live version" %}
                </a>
            {% endif %}

            {% with latest_revision.get_previous as previous_revision %}
            {% if previous_revision %}
                <a href="{% url 'wagtailadmin_pages:revisions_compare' page.id previous_revision.id latest_revision.id %}" class="button button-small button-secondary">{% trans 'Compare with previous revision' %}</a></li>
            {% endif %}
            {% endwith %}
        {% endwith %}
    </p>
</div>
